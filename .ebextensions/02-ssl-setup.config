# SSL Certificate and HTTPS Configuration
commands:
  01_create_ssl_directories:
    command: |
      mkdir -p /etc/ssl/private /etc/ssl/certs
      chmod 700 /etc/ssl/private
      chmod 755 /etc/ssl/certs
    ignoreErrors: true
    
  02_generate_ssl_certificate:
    command: |
      # Generate self-signed certificate for single instance
      openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
        -keyout /etc/ssl/private/server.key \
        -out /etc/ssl/certs/server.crt \
        -subj "/C=IN/ST=Delhi/L=Delhi/O=SaveMedia/OU=API/CN=*.elasticbeanstalk.com"
      
      # Set proper permissions
      chmod 600 /etc/ssl/private/server.key
      chmod 644 /etc/ssl/certs/server.crt
      
      # Create dhparam for better security
      openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
    ignoreErrors: true
    test: "[ ! -f /etc/ssl/certs/server.crt ]"

# Security Group Rule for HTTPS
Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0
